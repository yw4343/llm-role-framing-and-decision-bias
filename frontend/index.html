<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Framing and Decision Bias in LLMs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            position: relative;
            background: linear-gradient(135deg, #3a5f8f 0%, #5a7fb5 100%);
            color: white;
            padding: 40px 30px 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            transition: background 0.3s, transform 0.2s;
            text-decoration: none;
            color: white;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .github-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .github-link svg {
            width: 17px;
            height: 17px;
            fill: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #444;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #5a7fb5;
        }

        .tab.active {
            color: #5a7fb5;
            border-bottom-color: #5a7fb5;
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: none;
            border: 1px solid #444;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2 {
            color: #e0e0e0;
            margin-bottom: 30px;
            margin-top: 10px;
            font-size: 2em;
            font-weight: 600;
        }

        .tab-content h3 {
            color: #e0e0e0;
            margin-bottom: 20px;
            margin-top: 15px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #5a7fb5;
            background-color: #1f1f1f;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }


        .multi-select {
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 6px;
            padding: 8px;
        }

        .multi-select option {
            padding: 8px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .multi-select option:checked {
            background-color: #5a7fb5;
            color: white;
        }

        .button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3a5f8f 0%, #5a7fb5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(90, 127, 181, 0.4);
        }

        .button-danger {
            background: linear-gradient(135deg, #c53030 0%, #e53e3e 100%);
        }

        .button-danger:hover:not(:disabled) {
            box-shadow: 0 4px 8px rgba(197, 48, 48, 0.4);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover:not(:disabled) {
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.4);
        }

        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .status-message.success {
            background: #1e4620;
            color: #a5d6a7;
            border: 1px solid #4caf50;
        }

        .status-message.error {
            background: #4a1f1f;
            color: #ef9a9a;
            border: 1px solid #f44336;
        }

        .status-message.info {
            background: #1a3a4a;
            color: #90caf9;
            border: 1px solid #2196f3;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #444;
            border-top: 3px solid #5a7fb5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        .progress-container {
            margin: 20px 0;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #444;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background-color: #2a2a2a;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #444;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3a5f8f 0%, #5a7fb5 50%, #6b8fc5 100%);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            min-width: 50px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #e0e0e0;
            font-size: 0.9em;
        }

        .progress-message {
            color: #999;
            font-style: italic;
            margin-top: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2a2a;
        }

        thead {
            background: #1a1a1a;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
            color: #e0e0e0;
        }

        th {
            font-weight: 600;
            color: #e0e0e0;
            position: sticky;
            top: 0;
            background: #1a1a1a;
        }

        tr:hover {
            background: #333;
        }

        .checkbox-cell {
            text-align: center;
        }

        .experiment-selector {
            margin-bottom: 20px;
        }

        .experiment-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 6px;
            font-size: 1em;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .experiment-selector label {
            color: #e0e0e0;
            margin-bottom: 8px;
            display: block;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 0px;
        }

        .comparison-panel {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }

        .comparison-panel h3 {
            margin-bottom: 15px;
            color: #5a7fb5;
            border-bottom: 2px solid #5a7fb5;
            padding-bottom: 10px;
        }

        .comparison-field {
            margin-bottom: 15px;
        }

        .comparison-field label {
            font-weight: 600;
            color: #e0e0e0;
            display: block;
            margin-bottom: 5px;
        }

        .comparison-field .value {
            padding: 8px;
            background: #2a2a2a;
            border-radius: 4px;
            min-height: 40px;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        .response-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            font-size: 0.95em;
            color: #e0e0e0;
            border: 1px solid #444;
            line-height: 1.6;
            text-align: left;
        }

        .response-text strong {
            font-weight: bold;
            color: #fff;
        }

        .response-text em {
            font-style: italic;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .score-item {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #444;
        }

        .score-item label {
            display: block;
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        .score-item .score {
            font-size: 1.5em;
            font-weight: bold;
            color: #5a7fb5;
        }

        .select-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .help-text {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }

        .api-config {
            background: #2a2a2a;
            border: 1px solid #5a7fb5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .api-config label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .api-config input {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .api-config small {
            color: #999;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>Role Framing and Decision Bias in LLMs</h1>
            <a href="https://github.com/yw4343/llm-role-framing-and-decision-bias" target="_blank" rel="noopener noreferrer" class="github-link" title="View on GitHub">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <span>GitHub</span>
            </a>
        </div>

        <div class="api-config">
            <label for="api-base">API Base URL:</label>
            <input type="text" id="api-base" value="" placeholder="http://localhost:5001/api">
            <small>Enter your backend API URL. For local development, use http://localhost:5001/api</small>
        </div>

        <div id="status-message" class="status-message" style="display: none;"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('run')">Run Experiment</button>
            <button class="tab" onclick="showTab('results')">View Results</button>
            <button class="tab" id="compare-tab" onclick="showTab('compare')" disabled>Compare (0 selected)</button>
        </div>

        <!-- Run Experiment Tab -->
        <div id="tab-run" class="tab-content active">
            <h2 style="margin-bottom: 30px; margin-top: 10px;">Run New Experiment</h2>
            <form id="experiment-form" onsubmit="handleSubmit(event)">
                <div class="form-group" style="margin-bottom: 30px;">
                    <label for="OPENROUTER_API_KEY">OpenRouter API Key</label>
                    <input type="password" id="OPENROUTER_API_KEY" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="RESPONSE_MODEL_1">Response Model 1</label>
                        <input type="text" id="RESPONSE_MODEL_1" value="openai/gpt-4.1-mini" placeholder="e.g., openai/gpt-4.1-mini" required>
                        <div class="help-text">e.g., openai/gpt-4.1-mini</div>
                    </div>
                    <div class="form-group">
                        <label for="RESPONSE_MODEL_2">Response Model 2</label>
                        <input type="text" id="RESPONSE_MODEL_2" value="anthropic/claude-3.7-sonnet" placeholder="e.g., anthropic/claude-3.7-sonnet" required>
                        <div class="help-text">e.g., anthropic/claude-3.7-sonnet</div>
                    </div>
                    <div class="form-group">
                        <label for="JUDGE_MODEL">Judge Model</label>
                        <input type="text" id="JUDGE_MODEL" value="meta-llama/llama-3.1-70b-instruct" placeholder="e.g., meta-llama/llama-3.1-70b-instruct" required>
                        <div class="help-text">Must be from different family than models 1 & 2</div>
                    </div>
                    <div class="form-group">
                        <label for="NUM_ITERATIONS">Number of Iterations</label>
                        <input type="number" id="NUM_ITERATIONS" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="RESPONSE_TEMPERATURE">Response Temperature</label>
                        <input type="number" id="RESPONSE_TEMPERATURE" value="0.1" step="0.1" min="0" max="2">
                    </div>
                    <div class="form-group">
                        <label for="JUDGE_TEMPERATURE">Judge Temperature</label>
                        <input type="number" id="JUDGE_TEMPERATURE" value="0.0" step="0.1" min="0" max="2">
                    </div>
                </div>

                <div style="margin-top: 30px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 20px; margin-top: 10px;">Scenarios & Roles</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="SCENARIOS">Scenarios</label>
                            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                                <button type="button" class="button-secondary" style="padding: 5px 10px; font-size: 0.85em;" onclick="toggleSelectAll('SCENARIOS', this)">Select All</button>
                            </div>
                            <select id="SCENARIOS" multiple class="multi-select" required>
                                <option value="pricing_strategy">Pricing Strategy</option>
                                <option value="hiring_decision">Hiring Decision</option>
                                <option value="crisis_response">Crisis Response</option>
                                <option value="ai_deployment_ethics">AI Deployment Ethics</option>
                                <option value="data_privacy_tradeoff">Data Privacy Trade-off</option>
                            </select>
                            <div class="help-text">Hold Ctrl/Cmd to select multiple, or use the button above</div>
                        </div>
                        <div class="form-group">
                            <label for="ROLES">Roles</label>
                            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                                <button type="button" class="button-secondary" style="padding: 5px 10px; font-size: 0.85em;" onclick="toggleSelectAll('ROLES', this)">Select All</button>
                            </div>
                            <select id="ROLES" multiple class="multi-select" required>
                                <option value="higher_executive">Higher Executive</option>
                                <option value="middle_manager">Middle Manager</option>
                                <option value="intern">Intern</option>
                                <option value="technical_expert">Technical Expert</option>
                                <option value="compliance_officer">Compliance Officer</option>
                                <option value="neutral">Neutral</option>
                            </select>
                            <div class="help-text">Hold Ctrl/Cmd to select multiple, or use the button above</div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="button" id="run-button">Run Experiment</button>
            </form>

            <div id="experiment-status" style="margin-top: 30px; display: none;">
                <h3>Experiment Status</h3>
                <div class="status-message info" id="status-content"></div>
                <div id="progress-container" class="progress-container" style="display: none;">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progress-bar" style="width: 0%;">0%</div>
                    </div>
                    <div class="progress-info">
                        <span id="progress-text">0 / 0</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress-message" id="progress-message">Initializing...</div>
                </div>
                <button id="stop-button" class="button button-danger" style="margin-top: 15px; display: none;" onclick="stopExperiment()">Stop</button>
            </div>
        </div>

        <!-- View Results Tab -->
        <div id="tab-results" class="tab-content">
            <h2 style="margin-bottom: 30px; margin-top: 10px;">View Experiment Results</h2>
            <div class="experiment-selector">
                <label for="experiment-select">Select Experiment:</label>
                <select id="experiment-select" onchange="loadExperimentResults()">
                    <option value="">-- Select an experiment --</option>
                </select>
            </div>

            <div id="results-content"></div>
        </div>

        <!-- Compare Tab -->
        <div id="tab-compare" class="tab-content">
            <h2 style="margin-bottom: 5px; margin-top: 10px;">Side-by-Side Comparison</h2>
            <div id="compare-content" class="empty-state">
                <h3>No Comparison Data</h3>
                <p>Please select 2 records from the Results tab to compare.</p>
            </div>
        </div>
    </div>

    <script>
        // Get API base URL from environment or default to localhost
        function getDefaultApiBase() {
            // Check if we're in a deployed environment (window.location.hostname is not localhost)
            const hostname = window.location.hostname;
            if (hostname && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                // In production, use the same origin as the frontend
                return window.location.origin + '/api';
            }
            // Default to localhost for local development
            return 'http://localhost:5001/api';
        }

        // Initialize API base input with default value
        const apiBaseInput = document.getElementById('api-base');
        apiBaseInput.value = getDefaultApiBase();

        let currentExperimentId = null;
        let experimentStatusInterval = null;
        let experiments = [];
        let experimentResults = null;
        let selectedForComparison = [];
        let comparisonData = [];

        // Update API base when changed
        apiBaseInput.addEventListener('change', function() {
            window.API_BASE = this.value;
        });
        window.API_BASE = apiBaseInput.value;

        function getApiBase() {
            const inputValue = document.getElementById('api-base').value.trim();
            return inputValue || getDefaultApiBase();
        }

        function showStatusMessage(type, text) {
            const msg = document.getElementById('status-message');
            msg.className = `status-message ${type}`;
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // Set active tab button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find the tab button by text or index
                const tabs = document.querySelectorAll('.tab');
                if (tabName === 'run') tabs[0]?.classList.add('active');
                else if (tabName === 'results') tabs[1]?.classList.add('active');
                else if (tabName === 'compare') tabs[2]?.classList.add('active');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            showStatusMessage('info', 'Starting experiment...');

            // Get selected scenarios and roles (shared for both models)
            const scenarios = Array.from(document.getElementById('SCENARIOS').selectedOptions).map(opt => opt.value);
            const roles = Array.from(document.getElementById('ROLES').selectedOptions).map(opt => opt.value);

            if (scenarios.length === 0 || roles.length === 0) {
                showStatusMessage('error', 'Please select at least one scenario and role');
                return;
            }

            const formData = {
                OPENROUTER_API_KEY: document.getElementById('OPENROUTER_API_KEY').value,
                RESPONSE_MODEL_1: document.getElementById('RESPONSE_MODEL_1').value,
                RESPONSE_MODEL_2: document.getElementById('RESPONSE_MODEL_2').value,
                JUDGE_MODEL: document.getElementById('JUDGE_MODEL').value,
                SCENARIOS: scenarios,
                ROLES: roles,
                NUM_ITERATIONS: parseInt(document.getElementById('NUM_ITERATIONS').value),
                RESPONSE_TEMPERATURE: parseFloat(document.getElementById('RESPONSE_TEMPERATURE').value),
                JUDGE_TEMPERATURE: parseFloat(document.getElementById('JUDGE_TEMPERATURE').value),
            };

            try {
                const apiBase = getApiBase();
                const response = await fetch(`${apiBase}/experiments/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                }).catch(fetchError => {
                    throw new Error(`Cannot connect to backend server at ${apiBase}. Make sure the Flask server is running.`);
                });

                if (!response.ok) {
                    let errorMessage = `Server error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        // If response isn't JSON, use status text
                    }
                    showStatusMessage('error', errorMessage);
                    return;
                }

                const data = await response.json();
                currentExperimentId = data.experiment_id;
                document.getElementById('experiment-status').style.display = 'block';
                document.getElementById('run-button').disabled = true;
                document.getElementById('progress-container').style.display = 'block';
                document.getElementById('stop-button').style.display = 'block';
                checkExperimentStatus(data.experiment_id);
            } catch (error) {
                showStatusMessage('error', `Error: ${error.message}`);
            }
        }

        async function checkExperimentStatus(experimentId) {
            if (experimentStatusInterval) {
                clearInterval(experimentStatusInterval);
            }

            experimentStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${getApiBase()}/experiments/${experimentId}/status`);
                    const data = await response.json();

                    const statusContent = document.getElementById('status-content');
                    const progressContainer = document.getElementById('progress-container');
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    const progressPercentage = document.getElementById('progress-percentage');
                    const progressMessage = document.getElementById('progress-message');
                    const stopButton = document.getElementById('stop-button');
                    
                    if (data.status === 'running' || data.status === 'initializing') {
                        statusContent.innerHTML = `
                            <div>Status: <strong>Running</strong></div>
                        `;
                        progressContainer.style.display = 'block';
                        stopButton.style.display = 'block';
                        
                        // Update progress bar
                        const progress = data.progress || 0;
                        const current = data.current || 0;
                        const total = data.total || 0;
                        const message = data.message || 'Processing...';
                        
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                        progressText.textContent = `${current} / ${total}`;
                        progressPercentage.textContent = `${progress}%`;
                        progressMessage.textContent = message;
                    } else if (data.status === 'stopping') {
                        statusContent.innerHTML = `
                            <div>Status: <strong>Stopping</strong></div>
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Stopping experiment...</span>
                            </div>
                        `;
                        stopButton.disabled = true;
                    } else if (data.status === 'stopped') {
                        clearInterval(experimentStatusInterval);
                        statusContent.innerHTML = `
                            <div>Status: <strong>Stopped</strong></div>
                            <div style="margin-top: 10px; color: #d69e2e;">Experiment was stopped by user</div>
                        `;
                        progressContainer.style.display = 'none';
                        stopButton.style.display = 'none';
                        document.getElementById('run-button').disabled = false;
                        showStatusMessage('info', 'Experiment was stopped');
                    } else if (data.status === 'completed') {
                        clearInterval(experimentStatusInterval);
                        statusContent.innerHTML = `
                            <div>Status: <strong>Completed</strong></div>
                            <div style="margin-top: 10px;">Run ID: ${data.run_id}</div>
                            <div style="margin-top: 15px;">
                                <button class="button" onclick="downloadExperiment('${data.run_id}')" style="padding: 10px 20px;">
                                    Download Results
                                </button>
                            </div>
                        `;
                        progressContainer.style.display = 'none';
                        stopButton.style.display = 'none';
                        document.getElementById('run-button').disabled = false;
                        showStatusMessage('success', 'Experiment completed successfully!');
                        loadExperiments();
                    } else if (data.status === 'error') {
                        clearInterval(experimentStatusInterval);
                        statusContent.innerHTML = `
                            <div>Status: <strong>Error</strong></div>
                            <div style="margin-top: 10px; color: #721c24;">Error: ${data.error}</div>
                        `;
                        progressContainer.style.display = 'none';
                        stopButton.style.display = 'none';
                        document.getElementById('run-button').disabled = false;
                        showStatusMessage('error', `Error: ${data.error}`);
                    }
                } catch (error) {
                    // Error checking status
                }
            }, 2000);
        }

        async function stopExperiment() {
            if (!currentExperimentId) {
                return;
            }

            if (!confirm('Are you sure you want to stop the experiment? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${getApiBase()}/experiments/${currentExperimentId}/stop`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    showStatusMessage('error', errorData.error || 'Failed to stop experiment');
                    return;
                }

                showStatusMessage('info', 'Stop request sent. Experiment will stop after current task completes.');
            } catch (error) {
                showStatusMessage('error', `Error stopping experiment: ${error.message}`);
            }
        }

        async function loadExperiments() {
            try {
                const response = await fetch(`${getApiBase()}/experiments`);
                experiments = await response.json();
                
                const select = document.getElementById('experiment-select');
                select.innerHTML = '<option value="">-- Select an experiment --</option>';
                experiments.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp.run_id;
                    option.textContent = `${exp.timestamp} - ${exp.run_id.substring(0, 8)} (${exp.num_responses} responses)`;
                    select.appendChild(option);
                });
            } catch (error) {
                // Error loading experiments
            }
        }

        function extractChoice(responseText) {
            if (!responseText) return "";
            const text = responseText.trim();
            const pattern1 = /Choice:\s*Option\s+([ABCD])/i;
            const match = text.match(pattern1);
            if (match) return match[1].toUpperCase();
            const pattern2 = /\b([ABCD])\s*\)/i;
            const match2 = text.match(pattern2);
            if (match2) return match2[1].toUpperCase();
            const pattern3 = /(?:option|choice|select|answer|decision|recommendation|choose)\s+([ABCD])/i;
            const match3 = text.match(pattern3);
            if (match3) return match3[1].toUpperCase();
            return "";
        }

        function formatResponseText(text) {
            if (!text) return "";
            // Escape HTML first to prevent XSS
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Convert **bold** to <strong>bold</strong>
            formatted = formatted.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em>italic</em> (only single asterisks, not double)
            formatted = formatted.replace(/(?<!\*)\*([^*\n]+?)\*(?!\*)/g, '<em>$1</em>');
            
            // Convert line breaks to <br>
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        async function loadExperimentResults() {
            const runId = document.getElementById('experiment-select').value;
            if (!runId) {
                document.getElementById('results-content').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${getApiBase()}/experiments/${runId}/results`);
                experimentResults = await response.json();
                selectedForComparison = [];
                comparisonData = [];
                updateResultsTable();
                updateCompareTabButton();
            } catch (error) {
                showStatusMessage('error', `Error loading results: ${error.message}`);
            }
        }

        function updateResultsTable() {
            if (!experimentResults || !experimentResults.results) return;

            const selectedCount = selectedForComparison.length;
            const resultsHtml = `
                <h3 style="margin-bottom: 20px; margin-top: 10px;">Results Table</h3>
                <div class="select-buttons">
                    <button class="button" onclick="downloadExperiment('${experimentResults.run_id}')" style="padding: 10px 20px;">
                        Download Results
                    </button>
                    <button class="button button-secondary" onclick="loadComparisonData()" 
                            id="compare-button" ${selectedCount !== 2 ? 'disabled' : ''}>
                        Compare Selected (${selectedCount}/2)
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-cell">Select</th>
                                <th>Scenario</th>
                                <th>Role</th>
                                <th>Model</th>
                                <th>Iteration</th>
                                <th>Choice</th>
                                <th>Rationality</th>
                                <th>Comprehensiveness</th>
                                <th>Analytical Depth</th>
                                <th>Integrity</th>
                                <th>Bias Mitigation</th>
                                <th>Average Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${experimentResults.results.map(result => {
                                const resultKey = `${experimentResults.run_id}|${result.id}`;
                                const isSelected = selectedForComparison.includes(resultKey);
                                return `
                                    <tr>
                                        <td class="checkbox-cell">
                                            <input type="checkbox" 
                                                   ${isSelected ? 'checked' : ''}
                                                   onchange="handleSelectForComparison('${resultKey}')"
                                                   ${!isSelected && selectedForComparison.length >= 2 ? 'disabled' : ''}>
                                        </td>
                                        <td>${result.scenario}</td>
                                        <td>${result.role}</td>
                                        <td>${result.model}</td>
                                        <td>${result.iteration}</td>
                                        <td>${result.choice || '-'}</td>
                                        <td>${result.rationality.toFixed(2)}</td>
                                        <td>${result.comprehensiveness.toFixed(2)}</td>
                                        <td>${result.analytical_depth.toFixed(2)}</td>
                                        <td>${result.integrity.toFixed(2)}</td>
                                        <td>${result.bias_mitigation.toFixed(2)}</td>
                                        <td><strong>${result.average_score.toFixed(2)}</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('results-content').innerHTML = resultsHtml;
            updateCompareTabButton();
        }

        function handleSelectForComparison(resultKey) {
            const index = selectedForComparison.indexOf(resultKey);
            if (index > -1) {
                selectedForComparison.splice(index, 1);
            } else if (selectedForComparison.length < 2) {
                selectedForComparison.push(resultKey);
            } else {
                selectedForComparison = [selectedForComparison[1], resultKey];
            }
            updateResultsTable();
            updateCompareTabButton();
        }

        function updateCompareTabButton() {
            const count = selectedForComparison.length;
            const compareTab = document.getElementById('compare-tab');
            const compareButton = document.getElementById('compare-button');
            
            if (compareTab) {
                compareTab.textContent = `Compare (${count} selected)`;
                compareTab.disabled = count !== 2;
            }
            
            if (compareButton) {
                compareButton.textContent = `Compare Selected (${count}/2)`;
                compareButton.disabled = count !== 2;
            }
        }

        async function loadComparisonData() {
            if (selectedForComparison.length !== 2) {
                showStatusMessage('error', 'Please select exactly 2 records to compare');
                return;
            }

            try {
                showStatusMessage('info', 'Loading comparison data...');
                
                const [runId1, resultId1] = selectedForComparison[0].split('|');
                const [runId2, resultId2] = selectedForComparison[1].split('|');

                // URL encode the result IDs in case they contain special characters
                const encodedId1 = encodeURIComponent(resultId1);
                const encodedId2 = encodeURIComponent(resultId2);

                const [response1, response2] = await Promise.all([
                    fetch(`${getApiBase()}/experiments/${runId1}/response/${encodedId1}`),
                    fetch(`${getApiBase()}/experiments/${runId2}/response/${encodedId2}`)
                ]);

                if (!response1.ok) {
                    throw new Error(`Failed to load record 1: ${response1.status} ${response1.statusText}`);
                }
                if (!response2.ok) {
                    throw new Error(`Failed to load record 2: ${response2.status} ${response2.statusText}`);
                }

                const [data1, data2] = await Promise.all([
                    response1.json(),
                    response2.json()
                ]);

                comparisonData = [data1, data2];
                showComparison();
                
                // Switch to compare tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const compareTab = document.getElementById('compare-tab');
                const compareContent = document.getElementById('tab-compare');
                
                if (compareTab && compareContent) {
                    compareTab.classList.add('active');
                    compareTab.disabled = false;
                    compareContent.classList.add('active');
                }
            } catch (error) {
                showStatusMessage('error', `Error loading comparison: ${error.message}`);
            }
        }

        function showComparison() {
            if (comparisonData.length !== 2) {
                document.getElementById('compare-content').innerHTML = `
                    <div class="empty-state">
                        <h3>No Comparison Data</h3>
                        <p>Please select 2 records from the Results tab to compare.</p>
                    </div>
                `;
                return;
            }

            const [data1, data2] = comparisonData;
            const eval1 = data1.evaluation;
            const eval2 = data2.evaluation;
            const avg1 = eval1 ? (eval1.rationality + eval1.comprehensiveness + eval1.analytical_depth + eval1.integrity + eval1.bias_mitigation) / 5 : 0;
            const avg2 = eval2 ? (eval2.rationality + eval2.comprehensiveness + eval2.analytical_depth + eval2.integrity + eval2.bias_mitigation) / 5 : 0;

            document.getElementById('compare-content').innerHTML = `
                <div class="comparison-container">
                    <div class="comparison-panel">
                        <h3>Record 1</h3>
                        <div class="comparison-field">
                            <label>Scenario</label>
                            <div class="value">${data1.scenario}</div>
                        </div>
                        <div class="comparison-field">
                            <label>Role</label>
                            <div class="value">${data1.role}</div>
                        </div>
                        <div class="comparison-field">
                            <label>Model</label>
                            <div class="value">${data1.model}</div>
                        </div>
                        <div class="comparison-field">
                            <label>Choice</label>
                            <div class="value">${data1.choice || 'N/A'}</div>
                        </div>
                        ${eval1 ? `
                        <div class="comparison-field">
                            <label>Scores</label>
                            <div class="score-grid">
                                <div class="score-item">
                                    <label>Rationality</label>
                                    <div class="score">${eval1.rationality.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Comprehensiveness</label>
                                    <div class="score">${eval1.comprehensiveness.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Analytical Depth</label>
                                    <div class="score">${eval1.analytical_depth.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Integrity</label>
                                    <div class="score">${eval1.integrity.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Bias Mitigation</label>
                                    <div class="score">${eval1.bias_mitigation.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Average</label>
                                    <div class="score">${avg1.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="comparison-field">
                            <label>Full Response</label>
                            <div class="response-text">${formatResponseText(data1.response)}</div>
                        </div>
                    </div>

                    <div class="comparison-panel">
                        <h3>Record 2</h3>
                        <div class="comparison-field">
                            <label>Scenario</label>
                            <div class="value">${data2.scenario}</div>
                        </div>
                        <div class="comparison-field">
                            <label>Role</label>
                            <div class="value">${data2.role}</div>
                        </div>
                        <div class="comparison-field">
                            <label>Model</label>
                            <div class="value">${data2.model}</div>
                        </div>
                        <div class="comparison-field">
                            <label>Choice</label>
                            <div class="value">${data2.choice || 'N/A'}</div>
                        </div>
                        ${eval2 ? `
                        <div class="comparison-field">
                            <label>Scores</label>
                            <div class="score-grid">
                                <div class="score-item">
                                    <label>Rationality</label>
                                    <div class="score">${eval2.rationality.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Comprehensiveness</label>
                                    <div class="score">${eval2.comprehensiveness.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Analytical Depth</label>
                                    <div class="score">${eval2.analytical_depth.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Integrity</label>
                                    <div class="score">${eval2.integrity.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Bias Mitigation</label>
                                    <div class="score">${eval2.bias_mitigation.toFixed(2)}</div>
                                </div>
                                <div class="score-item">
                                    <label>Average</label>
                                    <div class="score">${avg2.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="comparison-field">
                            <label>Full Response</label>
                            <div class="response-text">${formatResponseText(data2.response)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function downloadExperiment(runId) {
            try {
                const apiBase = getApiBase();
                const response = await fetch(`${apiBase}/experiments/${runId}/download`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    showStatusMessage('error', errorData.error || 'Failed to download experiment');
                    return;
                }
                
                // Get the blob from the response
                const blob = await response.blob();
                
                // Create a temporary URL and trigger download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `experiment_${runId.substring(0, 8)}.json`;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showStatusMessage('success', 'Download started!');
            } catch (error) {
                showStatusMessage('error', `Error downloading experiment: ${error.message}`);
            }
        }

        function toggleSelectAll(selectId, button) {
            const select = document.getElementById(selectId);
            if (select) {
                const options = Array.from(select.options);
                const allSelected = options.every(option => option.selected);
                
                if (allSelected) {
                    // Deselect all
                    options.forEach(option => {
                        option.selected = false;
                    });
                    button.textContent = 'Select All';
                } else {
                    // Select all
                    options.forEach(option => {
                        option.selected = true;
                    });
                    button.textContent = 'Deselect All';
                }
            }
        }

        function selectAll(selectId) {
            const select = document.getElementById(selectId);
            if (select) {
                Array.from(select.options).forEach(option => {
                    option.selected = true;
                });
            }
        }

        function deselectAll(selectId) {
            const select = document.getElementById(selectId);
            if (select) {
                Array.from(select.options).forEach(option => {
                    option.selected = false;
                });
            }
        }

        // Load experiments on page load
        loadExperiments();

        // Select all options by default in multi-select dropdowns
        window.addEventListener('DOMContentLoaded', function() {
            const selects = ['SCENARIOS', 'ROLES'];
            selects.forEach(selectId => {
                selectAll(selectId);
                // Update button text to "Deselect All" since all are selected
                const button = document.querySelector(`button[onclick*="${selectId}"]`);
                if (button) {
                    button.textContent = 'Deselect All';
                }
            });
        });
    </script>
</body>
</html>
